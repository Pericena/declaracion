
<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>vehiculo</title>

    <script src="js/modernizr.js"></script>


<script src="https://unpkg.com/@tensorflow/tfjs"></script>
<script src="https://unpkg.com/@tensorflow-models/mobilenet"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script src="https://unpkg.com/ml5@0.5.0/dist/ml5.min.js"></script>
<script src="https://unpkg.com/ml5@0.5.0/dist/ml5.js"></script>



<script src ="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script> 
<script src ="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>


</head>


<body>
    <input type="file" onchange="showFiles()">
    <img id='idImage' crossorigin="anonymous" alt="Fotografía" style="width: 200px; height: 200px;" align="center">
    <div id="chart_div"></div>
    <div id="console"></div>
    <input type="text" id="message-input" placeholder="Escribe tu mensaje">
    <button id="btn-submit" onclick="sendMessage()">Enviar</button>
    <div id="status" style="display: none;"></div>
    <div id="history"></div>

    <script>
        // Código para cargar Mobilenet y realizar predicciones
        let net = null;

        async function app() {
            console.log('Loading mobilenet...');
            net = await mobilenet.load();
            console.log('Successfully loaded model');
            await predice();
        }

        async function predice() {
            const img_ = document.getElementById('idImage');
            if (img_.src != "") {
                const or_width = img_.width;
                const or_height = img_.height;
                img_.width = 224;
                img_.height = 224;

                const result = await net.classify(img_);

                let text_ = '';

                for (let iter = 0; iter < result.length; iter++) {
                    text_ += '\n predicción:' + result[iter].className + '\n';
                }

                document.getElementById('console').innerText = text_;

                console.log(text_);
                img_.width = or_width;
                img_.height = or_height;

                drawStacked(result);
                console.log(result);
            }
        }

        // Código para Google Charts
        google.charts.load('current', { packages: ['corechart', 'bar'] });

        function drawStacked(result) {
            var data_ = Array(result.length + 1);

            data_[0] = ['clase', 'Probabilidad', { role: "style" }];
            data_[1] = [result[0].className, result[0].probability, '#90EE90'];

            for (let iter = 1; iter < result.length; iter++) {
                data_[iter + 1] = [result[iter].className, result[iter].probability, '#6F76C2'];
            }

            var data = google.visualization.arrayToDataTable(data_);

            var view = new google.visualization.DataView(data);
            view.setColumns([0, 1,
                {
                    calc: "stringify",
                    sourceColumn: 1,
                    type: "string",
                    role: "annotation"
                },
                2
            ]);

            var options = {
                width: 600,
                height: 200,
                bar: { groupWidth: "95%" },
                legend: { position: "none" },
            };

            var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
            chart.draw(view, options);
        }

        // Código para enviar mensajes a la API de OpenAI
        const apiKey = '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'; // Reemplaza con tu clave

        function sendMessage() {
            var message = document.getElementById('message-input');
            if (!message.value) {
                message.style.border = '1px solid red';
                return;
            }
            message.style.border = 'none';

            var status = document.getElementById('status');
            var btnSubmit = document.getElementById('btn-submit');

            status.style.display = 'block';
            status.innerHTML = 'Cargando...';
            btnSubmit.disabled = true;
            btnSubmit.style.cursor = 'not-allowed';
            message.disabled = true;

            fetch("https://api.openai.com/v1/completions", {
                method: 'POST',
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                },
                body: JSON.stringify({
                    model: "text-davinci-003",
                    prompt: message.value,
                    max_tokens: 2048,
                    temperature: 0.5
                })
            })
                .then((response) => response.json())
                .then((response) => {
                    let r = response.choices[0]['text'];
                    status.style.display = 'none';
                    showHistory(message.value, r);
                })
                .catch((e) => {
                    console.log(`Error -> ${e}`);
                    status.innerHTML = 'Error, inténtalo de nuevo más tarde...';
                })
                .finally(() => {
                    btnSubmit.disabled = false;
                    btnSubmit.style.cursor = 'pointer';
                    message.disabled = false;
                    message.value = '';
                });
        }

        function showHistory(message, response) {
            var historyBox = document.getElementById('history');

            // Mi mensaje
            var boxMyMessage = document.createElement('div');
            boxMyMessage.className = 'box-my-message';

            var myMessage = document.createElement('p');
            myMessage.className = 'my-message';
            myMessage.innerHTML = message;

            boxMyMessage.appendChild(myMessage);

            historyBox.appendChild(boxMyMessage);

            // Mensaje de respuesta
            var boxResponseMessage = document.createElement('div');
            boxResponseMessage.className = 'box-response-message';

            var chatResponse = document.createElement('p');
            chatResponse.className = 'response-message';
            chatResponse.innerHTML = response;

            boxResponseMessage.appendChild(chatResponse);

            historyBox.appendChild(boxResponseMessage);

            // Hacer scroll hacia abajo
            historyBox.scrollTop = historyBox.scrollHeight;
        }

        app();
    </script>
</body>
</html>
